#!/bin/bash

set -e

# Converts a raw collectd template to a go file with the template as a variable
# named "CollectdTemplate".  Should be called from the directory of the monitor
# package.

template_filename=$1
target_file=${2:-template.go}

package=$(basename $(pwd))

old_content=$(cat $target_file || echo -n "")

new_content=$(cat <<-EOH
package $package

// AUTOGENERATED BY scripts/collectd-template-to-go.  DO NOT EDIT!!

import "text/template"
import "github.com/signalfx/neo-agent/monitors/collectd/templating"

// CollectdTemplate is a template for a $package collectd config file
var CollectdTemplate = template.Must(templating.InjectTemplateFuncs(template.New("$package")).Parse(\`
$(cat $template_filename)
\`)).Option("missingkey=error")
EOH
)

# Don't write content if it's the same so we don't trigger a recompilation.
[[ $old_content == $new_content ]] || echo -n "$new_content" > $target_file
