#!/bin/bash

# Converts the agent docs here to the ReadTheDocs repo at
# https://github.com/signalfx/product-docs. You will probably have to provide
# the envvar $PRODUCT_DOCS_REPO, which is the directory path to the root of the
# product-docs repo.  It will overwrite any existing agent docs in the repo,
# but will not commit them to git.

set -euo pipefail

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
AGENT_REPO_BASE="$SCRIPT_DIR/../.."
PRODUCT_DOCS_REPO="${PRODUCT_DOCS_REPO:-$AGENT_REPO_BASE/../product-docs}"
AGENT_PRODUCT_DOCS="$PRODUCT_DOCS_REPO/integrations/agent"

header_comment() {
  printf ".. Generated by scripts/docs/to-product-docs in signalfx-agent repo. DO NOT EDIT in product-docs!!\n\n"
}

[ -d $PRODUCT_DOCS_REPO ] || \
  (echo "product-docs repo dir cannot be found at $PRODUCT_DOCS_REPO; please set \$PRODUCT_DOCS_REPO" && exit 1)

mkdir -p $AGENT_PRODUCT_DOCS/{monitors,observers}

for f in $(find $AGENT_REPO_BASE/docs -name "*.md"); do
  if [[ $f =~ signalfx-agent.1.md$ ]]; then
    continue
  fi

  out_file=$AGENT_PRODUCT_DOCS/$(echo $f | sed -e "s@${AGENT_REPO_BASE}/docs/@@" | sed 's/md/rst/')

  header_comment > $out_file
  pandoc -i $f \
  --from gfm \
  --to rst \
  --standalone \
  --reference-links \
  --columns=700 \
   >> $out_file

  if [[ $out_file =~ monitor-config.rst$ ]]; then
    cat <<EOH >> $out_file

.. toctree::
   :glob:
   :hidden:
   :maxdepth: 1

   ./monitors/*
EOH
  fi

  if [[ $out_file =~ observer-config.rst$ ]]; then
    cat <<EOH >> $out_file

.. toctree::
   :glob:
   :hidden:
   :maxdepth: 1

   ./observers/*
EOH
  fi

done

header_comment | \
  cat - $AGENT_REPO_BASE/README.md | \
    sed -e 's/# SignalFx Agent (SmartAgent)/# Overview/' | \
    sed -e '/GoDoc/d' | \
    pandoc --from gfm --to rst --standalone --reference-links --wrap none > $AGENT_PRODUCT_DOCS/overview.rst

# Convert links from markdown to html
find $AGENT_PRODUCT_DOCS -name "*.rst" | xargs sed -i '' -e 's/\.md[[:>:]]/.html/g' -e 's@\./docs/@./@g'
